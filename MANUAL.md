# 🦅 Musalink システム取扱説明書

このドキュメントは、Musalink（ムサリンク）の操作方法、管理方法、および開発/デプロイ手順をまとめたものです。

---

## 📚 目次
1.  **ユーザー向けガイド (User Guide)**
    *   はじめる準備 (アカウント・口座登録)
    *   出品の流れ
    *   購入の流れ (リクエスト〜決済)
    *   取引の完了と相互評価
2.  **管理者向けガイド (Admin Guide)**
    *   管理ダッシュボードの見方
    *   トラブル時の対応 (キャンセル・返金)
3.  **開発・運用者向けガイド (Developer & Ops)**
    *   ローカル開発環境の起動
    *   本番環境へのデプロイ
    *   共通トラブルシューティング

---

## 1. ユーザー向けガイド (User Guide)

### はじめる準備
初めて利用する場合、以下の登録が必要です。
*   **本人確認**: 学生証認証（`@stu.musashino-u.ac.jp` メール）が必要です。
*   **口座登録 (出品者のみ)**: 売上を受け取るために、Stripe Connectを通じた銀行口座登録が必要です。マイページの「売上管理」から登録してください。

### 出品の流れ
1.  ヘッダーの「出品する」ボタンをクリックします。
2.  **教科書情報**: ISBNを入力して「自動入力」を押すと便利です。授業名や先生名も入力すると、検索されやすくなります。
3.  **価格設定**: 販売価格を入力します（手数料は購入者負担です）。
4.  「出品する」を押すと、即座に一覧に表示されます。

### 購入の流れ (リクエスト〜決済)
Musalinkは「対面取引 × 予約決済」システムです。

1.  **リクエスト**: 欲しい商品を見つけたら「購入リクエスト」を送ります。
2.  **承認待ち**: 出品者がリクエストを承認するのを待ちます。
3.  **支払い予約 (Authorize)**:
    *   承認されると、「支払いを予約する」ボタンが表示されます。
    *   クレジットカード情報を入力します。**この時点では決済は確定しません（仮押さえ状態）。**
4.  **受け渡し (Handover)**:
    *   チャット機能で待ち合わせ場所（有明キャンパス 3号館前など）を決めます。
    *   実際に会って、商品の状態を確認します。

### 取引の完了と相互評価
1.  **QRコード決済 (Capture)**:
    *   商品を受け取ったら、買い手は「受取確認 QRコード」を表示します。
    *   売り手はそれをスマホでスキャンします。**スキャン成功と同時に、クレジットカード決済が確定します。**
2.  **相互評価**:
    *   取引が完了すると、互いに星評価（1〜5）を送ります。
    *   評価を完了すると、信頼スコアが更新されます。

---

## 2. 管理者向けガイド (Admin Guide)

管理者権限を持つユーザーは、以下のURLから管理画面にアクセスできます。
*   **URL**: `/admin` (例: `https://musa-link.web.app/admin`)

### 機能概要
*   **Dashboard**: 取引総額、ユーザー数、アクティブ出品数などのKPIを確認できます。
*   **Transaction Logs**: すべての取引履歴を確認できます。不審な取引（高額すぎる、短時間での連続取引など）がないか監視します。
*   **Users**: ユーザー一覧。本人確認ステータスやStripe連携状況を確認できます。

### トラブル時の対応
*   **取引キャンセル**: 管理画面、またはCloud Functionsの自動処理により、24時間反応がない取引は自動キャンセルされます。
*   **返金**: 決済確定前（予約段階）であれば、取引をキャンセルするだけでカードの仮押さえは解除されます。決済確定後の返金は、Stripeダッシュボードから行う必要があります。

---

## 3. 開発・運用者向けガイド (Developer & Ops)

### ローカル開発環境の起動
リポジトリをクローン後、以下のコマンドを実行します。

```bash
# 依存関係のインストール
npm install

# 開発サーバー起動
npm run dev
```
`http://localhost:3000` でアクセスできます。

### 本番環境へのデプロイ
修正を行った場合、以下のコマンドでFirebaseへデプロイします。
**注意**: Functions（バックエンド）とHosting（フロントエンド）の両方を更新することを推奨します。

```bash
# 全体をデプロイ
firebase deploy --only functions,hosting

# 特定のみデプロイする場合 (例: 画面修正のみ)
firebase deploy --only hosting
```

### 共通トラブルシューティング
*   **PCでボタンが反応しない**:
    *   以前のバージョンではHTML構造の問題がありましたが、修正済みです。ブラウザのキャッシュをクリアしてみてください。
*   **デプロイが失敗する (Functions)**:
    *   Windows環境の場合、Linux用の依存関係と競合することがあります。`functions/node_modules` を削除し、`functions/package-lock.json` を再生成してからデプロイしてください（自動化対応済みですが、念のため）。
*   **「相互評価ができない」**:
    *   セキュリティルールにより、クライアントからの直接書き込みは禁止されています。必ずデプロイ済みの `rateUser` Cloud Function経由で実行されているか確認してください。

---
*Document Version: 1.0 (2026-01-06)*
