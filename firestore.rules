rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Check if user is owner of the user profile
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper: Enforce University Email (or specific Demo/Admin accounts)
    // 匿名ログインは許可しない。書き込み権限は学内メール認証ユーザーのみ。
    function isVerifiedStudent() {
       return isAuthenticated() && (
         request.auth.token.email.matches('.*@stu.musashino-u.ac.jp') ||
         request.auth.token.email.matches('.*@musashino-u.ac.jp') ||
         request.auth.token.email == 'demo@musashino-u.ac.jp'
       );
    }

    // Users: Profiles (Public Read, Owner Write)
    // Note: Sensitive data should be stored in /users/{userId}/private_data/profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Admin only

      // Private Data Subcollection (Strictly Owner Only)
      match /private_data/{docId} {
          allow read, write: if isOwner(userId);
      }

      // Notifications Subcollection
      match /notifications/{notificationId} {
          allow read, write: if isOwner(userId);
      }
    }

    // Items: Public Read, Seller Write
    match /items/{itemId} {
      allow read: if true;
      allow create: if isVerifiedStudent() 
                    && request.resource.data.seller_id == request.auth.uid
                    && request.resource.data.description.size() < 2000; // Anti-Abuse: Max 2000 chars
      allow update: if isAuthenticated() && (
                      resource.data.seller_id == request.auth.uid
                      || (
                        // Allow Buyer to lock item (Transaction Start)
                        isVerifiedStudent() 
                        && resource.data.status == 'listing'
                        && request.resource.data.status == 'matching'
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
                      )
                    );
      allow delete: if isAuthenticated() && resource.data.seller_id == request.auth.uid;
    }

    // Transactions: Involved Parties Only
    match /transactions/{transactionId} {
      // Read: Buyer or Seller
      allow read: if isAuthenticated() && (resource.data.buyer_id == request.auth.uid || resource.data.seller_id == request.auth.uid);
      
      // Create: Buyer only (must match auth uid)
      allow create: if isVerifiedStudent() && request.resource.data.buyer_id == request.auth.uid;
      
      // Update: Buyer or Seller, BUT Restricted Status Changes
      // Update: Buyer or Seller with Strict State Machine（ホワイトリスト形式）
      // payment_pending -> completed は Cloud Functions のみ（クライアントからは不可）
      allow update: if isVerifiedStudent() 
                    && (resource.data.buyer_id == request.auth.uid || resource.data.seller_id == request.auth.uid)
                    && (
                      // 1. status を変更しない更新（meeting_place 等のみ）
                      (!('status' in request.resource.data) || request.resource.data.status == resource.data.status)
                      ||
                      // 2. 厳密なステータス遷移のみ許可
                      (
                         // request_sent -> cancelled (Both) or approved (Seller only)
                         (resource.data.status == 'request_sent' && (
                            (request.resource.data.status == 'cancelled') || 
                            (request.resource.data.status == 'approved' && request.auth.uid == resource.data.seller_id)
                         ))
                         ||
                         // approved -> cancelled (Both。支払い前のみ。payment_pending 後は不可)
                         (resource.data.status == 'approved' && request.resource.data.status == 'cancelled')
                         ||
                         // approved -> payment_pending (Buyer only。Stripe 認証後)
                         (resource.data.status == 'approved' && request.resource.data.status == 'payment_pending' && request.auth.uid == resource.data.buyer_id)
                      )
                      ||
                      // 3. [DEMO EXCEPTION] completed は Demo 取引のみクライアントから許可
                      (
                        resource.data.is_demo == true 
                        && request.resource.data.status == 'completed'
                      )
                    );
    }

    // Conversations & Messages (Chat)
    match /conversations/{conversationId} {
      // Allow read/update if user is a participant
      allow read, update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      // Allow create if user includes themselves in participants
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;

      match /messages/{messageId} {
        // Allow read/write if user is a participant of the parent conversation
        // Note: usage of get() incurs a read charge. 
        // We use the parent document to check permissions.
        allow read, write: if isAuthenticated() 
                           && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    // Payout Requests（ドキュメントIDは自動採番のため、resource.data.userId で本人判定）
    match /payout_requests/{requestId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || request.auth.token.admin == true);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Immutable once requested
    }

    // Reports
    match /reports/{reportId} {
        allow create: if isAuthenticated();
        allow read: if request.auth.token.admin == true;
    }
  }
}
